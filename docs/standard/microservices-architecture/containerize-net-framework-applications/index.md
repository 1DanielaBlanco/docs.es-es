---
title: Migrar aplicaciones de .NET Framework monolíticas heredadas a contenedores de Windows
description: Arquitectura de microservicios de .NET para aplicaciones .NET en contenedor | Migrar aplicaciones de .NET Framework monolíticas heredadas a contenedores de Windows
author: CESARDELATORRE
ms.author: wiwagn
ms.date: 05/26/2017
ms.openlocfilehash: a12012f115629a79734c18c3bc75733ae2fc8195
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 05/04/2018
ms.locfileid: "33578838"
---
# <a name="migrating-legacy-monolithic-net-framework-applications-to-windows-containers"></a><span data-ttu-id="5d532-103">Migrar aplicaciones de .NET Framework monolíticas heredadas a contenedores de Windows</span><span class="sxs-lookup"><span data-stu-id="5d532-103">Migrating Legacy Monolithic .NET Framework Applications to Windows Containers</span></span>

<span data-ttu-id="5d532-104">*Los contenedores de Windows pueden usarse como una manera para mejorar los entornos de desarrollo y pruebas y para implementar aplicaciones que se basan en tecnologías de .NET Framework heredadas, como formularios Web* *Forms. El uso de contenedores para aplicaciones heredadas de esta manera se conoce como “migración mediante lift-and-shift”.*</span><span class="sxs-lookup"><span data-stu-id="5d532-104">*Windows Containers can be used as a way to improve development and test environments, and to deploy applications that are based on legacy .NET Framework technologies like Web* *Forms. Using containers for legacy applications in this way is referred to as a “lift and shift” scenario.*</span></span>

<span data-ttu-id="5d532-105">Las secciones anteriores de esta guía han abogado por el uso de una arquitectura de microservicios en la que las aplicaciones empresariales se distribuyen entre diferentes contenedores, cada uno de los cuales ejecuta un pequeño servicio especializado.</span><span class="sxs-lookup"><span data-stu-id="5d532-105">Earlier sections of this guide have championed a microservices architecture where business applications are distributed among different containers, each running a small, focused service.</span></span> <span data-ttu-id="5d532-106">Este objetivo tiene numerosas ventajas.</span><span class="sxs-lookup"><span data-stu-id="5d532-106">That goal has many benefits.</span></span> <span data-ttu-id="5d532-107">En el desarrollo nuevo, se recomienda encarecidamente este enfoque.</span><span class="sxs-lookup"><span data-stu-id="5d532-107">In new development, that approach is strongly recommended.</span></span> <span data-ttu-id="5d532-108">Las aplicaciones fundamentales para la empresa también se verán lo bastante beneficiadas como para justificar el costo que supone el cambio de arquitectura y la reimplementación.</span><span class="sxs-lookup"><span data-stu-id="5d532-108">Enterprise-critical applications will also benefit enough to justify the cost of a rearchitecture and reimplementation.</span></span>

<span data-ttu-id="5d532-109">Pero no todas las aplicaciones se beneficiarán lo suficiente como para justificar dicho costo.</span><span class="sxs-lookup"><span data-stu-id="5d532-109">But not every application will benefit enough to justify the cost.</span></span> <span data-ttu-id="5d532-110">Esto no significa que esas aplicaciones no se puedan usar en escenarios de contenedor.</span><span class="sxs-lookup"><span data-stu-id="5d532-110">That does not mean that those applications cannot be used in container scenarios.</span></span>

<span data-ttu-id="5d532-111">En esta sección, exploraremos una aplicación para eShopOnContainers, mostrada en la figura 7-1.</span><span class="sxs-lookup"><span data-stu-id="5d532-111">In this section, we will explore an application for eShopOnContainers, shown in Figure 7-1.</span></span> <span data-ttu-id="5d532-112">Los usuarios de esta aplicación serían los miembros del equipo empresarial de eShopOnContainers, que la utilizarían para ver y editar el catálogo de productos.</span><span class="sxs-lookup"><span data-stu-id="5d532-112">This application would be used by members of the eShopOnContainers enterprise team to view and edit the product catalog.</span></span>

![](./media/image1.png)

<span data-ttu-id="5d532-113">**Figura 7-1**.</span><span class="sxs-lookup"><span data-stu-id="5d532-113">**Figure 7-1**.</span></span> <span data-ttu-id="5d532-114">Aplicación de formularios Web Forms ASP.NET (tecnología heredada) en un contenedor de Windows.</span><span class="sxs-lookup"><span data-stu-id="5d532-114">ASP.NET Web Forms application (legacy technology) on a Windows Container</span></span>

<span data-ttu-id="5d532-115">Se trata de una aplicación de formularios Web Forms que se usa para examinar y modificar las entradas del catálogo.</span><span class="sxs-lookup"><span data-stu-id="5d532-115">This is a Web Forms application that is used to browse and modify the catalog entries.</span></span> <span data-ttu-id="5d532-116">La dependencia de formularios Web Forms significa que esta aplicación no se ejecutará en .NET Core, a menos que se reescriba sin formularios Web Forms y use en su lugar MVC de ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="5d532-116">The Web Forms dependency means this application will not run on .NET Core unless it is rewritten without Web Forms and instead uses ASP.NET Core MVC.</span></span> <span data-ttu-id="5d532-117">Verá cómo puede ejecutar aplicaciones como estas en contenedores sin ningún cambio.</span><span class="sxs-lookup"><span data-stu-id="5d532-117">You will see how you can run applications like these in containers without changes.</span></span> <span data-ttu-id="5d532-118">También verá cómo puede realizar cambios mínimos para trabajar en un modo híbrido en el que alguna función se ha movido a un microservicio independiente, pero la mayoría de las funciones permanece en la aplicación monolítica.</span><span class="sxs-lookup"><span data-stu-id="5d532-118">You will also see how you can make minimal changes to work in a hybrid mode where some functionality has been moved into a separate microservice, but most functionality remains in the monolithic application.</span></span>

## <a name="benefits-of-containerizing-a-monolithic-application"></a><span data-ttu-id="5d532-119">Ventajas de incluir en un contenedor una aplicación monolítica</span><span class="sxs-lookup"><span data-stu-id="5d532-119">Benefits of containerizing a monolithic application</span></span>

<span data-ttu-id="5d532-120">La aplicación Catalog.WebForms está disponible en el repositorio de GitHub eShopOnContainers (<https://github.com/dotnet/eShopOnContainers>).</span><span class="sxs-lookup"><span data-stu-id="5d532-120">The Catalog.WebForms application is available in the eShopOnContainers GitHub repository (<https://github.com/dotnet/eShopOnContainers>).</span></span> <span data-ttu-id="5d532-121">Se trata de una aplicación web independiente que tiene acceso a un almacén de datos de alta disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="5d532-121">This application is a standalone web application accessing a high-availability data store.</span></span> <span data-ttu-id="5d532-122">Aun así, resulta beneficioso ejecutar la aplicación en un contenedor.</span><span class="sxs-lookup"><span data-stu-id="5d532-122">Even so, there are advantages to running the application in a container.</span></span> <span data-ttu-id="5d532-123">Cree una imagen de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="5d532-123">You create an image for the application.</span></span> <span data-ttu-id="5d532-124">A partir de ese momento, todas las implementaciones se ejecutarán en el mismo entorno.</span><span class="sxs-lookup"><span data-stu-id="5d532-124">From that point forward, every deployment runs in the same environment.</span></span> <span data-ttu-id="5d532-125">Cada contenedor usa la misma versión de sistema operativo, tiene instalada la misma versión de dependencias, usa el mismo marco de trabajo y se compila con el mismo proceso.</span><span class="sxs-lookup"><span data-stu-id="5d532-125">Every container uses the same OS version, has the same version of dependencies installed, uses the same framework, and is built using the same process.</span></span> <span data-ttu-id="5d532-126">En la figura 7-2 verá la aplicación cargada en Visual Studio 2017.</span><span class="sxs-lookup"><span data-stu-id="5d532-126">You can see the application loaded in Visual Studio 2017 in Figure 7-2.</span></span>

![](./media/image2.png)

<span data-ttu-id="5d532-127">**Figura 7-2**.</span><span class="sxs-lookup"><span data-stu-id="5d532-127">**Figure 7-2**.</span></span> <span data-ttu-id="5d532-128">Aplicación de formularios Web Forms de administración de catálogos en Visual Studio de 2017.</span><span class="sxs-lookup"><span data-stu-id="5d532-128">Catalog management Web Forms application in Visual Studio 2017</span></span>

<span data-ttu-id="5d532-129">Además, todos los desarrolladores pueden ejecutar la aplicación en este entorno coherente.</span><span class="sxs-lookup"><span data-stu-id="5d532-129">In addition, developers can all run the application in this consistent environment.</span></span> <span data-ttu-id="5d532-130">Los problemas que solo se manifiestan con determinadas versiones aparecerán de inmediato para los desarrolladores, en lugar de surgir en un entorno de ensayo o de producción.</span><span class="sxs-lookup"><span data-stu-id="5d532-130">Issues that only appear with certain versions will appear immediately for developers rather than surfacing in a staging or production environment.</span></span> <span data-ttu-id="5d532-131">Las diferencias entre los entornos de desarrollo dejan de ser tan importantes para el equipo de desarrollo una vez que las aplicaciones se ejecutan en contenedores.</span><span class="sxs-lookup"><span data-stu-id="5d532-131">Differences between the development environments among the development team matter less once applications run in containers.</span></span>

<span data-ttu-id="5d532-132">Por último, las aplicaciones en contenedor tienen una curva de escalado horizontal más plana.</span><span class="sxs-lookup"><span data-stu-id="5d532-132">Finally, containerized applications have a flatter scale-out curve.</span></span> <span data-ttu-id="5d532-133">Ya ha aprendido que las aplicaciones en contenedor permiten la existencia de más contenedores en una máquina virtual o más contenedores en una máquina física.</span><span class="sxs-lookup"><span data-stu-id="5d532-133">You have learned how containerized apps enable more containers in a VM or more containers in a physical machine.</span></span> <span data-ttu-id="5d532-134">Esto supone una mayor densidad y requiere menos recursos.</span><span class="sxs-lookup"><span data-stu-id="5d532-134">This translates to higher density and fewer required resources.</span></span>

<span data-ttu-id="5d532-135">Por todas estas razones, considere la posibilidad de ejecutar aplicaciones monolíticas heredadas en un contenedor de Docker mediante una operación de “migración mediante lift-and-shift”.</span><span class="sxs-lookup"><span data-stu-id="5d532-135">For all these reasons, consider running legacy monolithic apps in a Docker container using a “lift-and-shift” operation.</span></span> <span data-ttu-id="5d532-136">La expresión “lift-and-shift” describe el ámbito de la tarea: extrae (*lift*) toda la aplicación de una máquina física o virtual y la traslada (*shift*) a un contenedor.</span><span class="sxs-lookup"><span data-stu-id="5d532-136">The phrase “lift and shift” describes the scope of the task: you *lift* the entire application from a physical or virtual machine, and *shift* it into a container.</span></span> <span data-ttu-id="5d532-137">En situaciones ideales, no es necesario realizar ningún cambio en el código de la aplicación para que se ejecute en un contenedor.</span><span class="sxs-lookup"><span data-stu-id="5d532-137">In ideal situations, you do not need to make any changes to the application code to run it in a container.</span></span>

## <a name="possible-migration-paths"></a><span data-ttu-id="5d532-138">Posibles procedimientos de migración</span><span class="sxs-lookup"><span data-stu-id="5d532-138">Possible migration paths</span></span>

<span data-ttu-id="5d532-139">La aplicación monolítica Catalog.Webforms es una aplicación web que contiene todo el código, incluidas las bibliotecas de acceso a datos.</span><span class="sxs-lookup"><span data-stu-id="5d532-139">As a monolithic application, the Catalog.Webforms application is one web application containing all the code, including the data access libraries.</span></span> <span data-ttu-id="5d532-140">La base de datos se ejecuta en un equipo independiente de alta disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="5d532-140">The database runs on a separate high-availability machine.</span></span> <span data-ttu-id="5d532-141">Esta configuración se simula en el código de ejemplo mediante el uso de un servicio de catálogo ficticio. Esto significa que puede ejecutar la aplicación Catalog.WebForms con esos datos falsos para simular un escenario puro de migración mediante lift-and-shift.</span><span class="sxs-lookup"><span data-stu-id="5d532-141">That configuration is simulated in the sample code by using a mock catalog service: you can run the Catalog.WebForms application against that fake data to simulate a pure lift-and-shift scenario.</span></span> <span data-ttu-id="5d532-142">Esto muestra el procedimiento de migración más sencillo, según el cual se mueven los activos existentes para ejecutarlos en un contenedor sin realizar ningún cambio en el código.</span><span class="sxs-lookup"><span data-stu-id="5d532-142">This demonstrates the simplest migration path, where you move existing assets to run in a container without any code changes at all.</span></span> <span data-ttu-id="5d532-143">Este procedimiento es adecuado para las aplicaciones que están completas y que tienen una interacción mínima con las funciones que se van a mover a microservicios.</span><span class="sxs-lookup"><span data-stu-id="5d532-143">This path is appropriate for applications that are complete and that have minimal interaction with functionality that you are moving to microservices.</span></span>

<span data-ttu-id="5d532-144">Pero el sitio web de eShopOnContainers ya tiene acceso al almacenamiento de datos mediante microservicios para diferentes escenarios.</span><span class="sxs-lookup"><span data-stu-id="5d532-144">However, the eShopOnContainers website is already accessing the data storage using microservices for different scenarios.</span></span> <span data-ttu-id="5d532-145">Se pueden realizar algunos pequeños cambios adicionales en el editor del catálogo para aprovechar el microservicio de catálogo, en lugar de tener acceso directamente al almacenamiento de datos del catálogo.</span><span class="sxs-lookup"><span data-stu-id="5d532-145">Some small additional changes can be made to the catalog editor to leverage the catalog microservice instead of accessing the catalog data storage directly.</span></span>

<span data-ttu-id="5d532-146">Estos cambios muestran el continuo de sus propias aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="5d532-146">These changes demonstrate the continuum for your own applications.</span></span> <span data-ttu-id="5d532-147">Puede hacer de todo, desde mover a contenedores una aplicación existente sin cambiarla en absoluto, hasta realizar pequeños cambios que permiten que las aplicaciones existentes tengan acceso a algunos de los nuevos microservicios, pasando por reescribir completamente una aplicación para participar de lleno en una nueva arquitectura basada en microservicios.</span><span class="sxs-lookup"><span data-stu-id="5d532-147">You can do anything from moving an existing application without change into containers, to making small changes that enable existing applications to access some of the new microservices, to completely rewriting an application to fully participate in a new microservice-based architecture.</span></span> <span data-ttu-id="5d532-148">El procedimiento que elija dependerá del costo y de las ventajas de la migración.</span><span class="sxs-lookup"><span data-stu-id="5d532-148">The right path depends on both the cost of the migration and the benefits from any migration.</span></span>

## <a name="application-tour"></a><span data-ttu-id="5d532-149">Paseo por la aplicación</span><span class="sxs-lookup"><span data-stu-id="5d532-149">Application tour</span></span>

<span data-ttu-id="5d532-150">Puede cargar la solución Catalog.WebForms y ejecutar la aplicación como una aplicación independiente.</span><span class="sxs-lookup"><span data-stu-id="5d532-150">You can load the Catalog.WebForms solution and run the application as a standalone application.</span></span> <span data-ttu-id="5d532-151">En esta configuración, en lugar de una base de datos de almacenamiento persistente, la aplicación usa un servicio falso para devolver los datos.</span><span class="sxs-lookup"><span data-stu-id="5d532-151">In this configuration, instead of a persistent storage database, the application uses a fake service to return data.</span></span> <span data-ttu-id="5d532-152">En la aplicación se usa Autofac (<https://autofac.org/>) como contenedor de inversión de control (IOC).</span><span class="sxs-lookup"><span data-stu-id="5d532-152">The application uses Autofac (<https://autofac.org/>) as an inversion of control (IOC) container.</span></span> <span data-ttu-id="5d532-153">Mediante la inserción de dependencias (DI), puede configurar la aplicación para que use los datos falsos o el servicio de datos de catálogo activo.</span><span class="sxs-lookup"><span data-stu-id="5d532-153">Using Dependency Injection (DI), you can configure the application to use the fake data or the live catalog data service.</span></span> <span data-ttu-id="5d532-154">(Más adelante explicaremos con más detalle la inserción de dependencias). El código de inicio lee un valor useFake en los archivos web.config y configura el contenedor Autofac para insertar el servicio de datos falsos o el servicio de catálogo activo.</span><span class="sxs-lookup"><span data-stu-id="5d532-154">(We will explain more about DI shortly.) The startup code reads a useFake setting from the web.config files, and configures the Autofac container to inject either the fake data service or the live catalog service.</span></span> <span data-ttu-id="5d532-155">Si ejecuta la aplicación con useFake establecido en false en el archivo web.config, verá que la aplicación de formularios Web Forms muestra los datos del catálogo.</span><span class="sxs-lookup"><span data-stu-id="5d532-155">If you run the application with useFake set to false in the web.config file, you see the Web Forms application displaying the catalog data.</span></span>

<span data-ttu-id="5d532-156">La mayoría de las técnicas usadas en esta aplicación le resultarán conocidas a cualquier persona que haya usado formularios Web Forms.</span><span class="sxs-lookup"><span data-stu-id="5d532-156">Most of the techniques used in this application should be very familiar to anyone who has used Web Forms.</span></span> <span data-ttu-id="5d532-157">Aun así, el microservicio de catálogo introduce dos técnicas con las que probablemente no esté familiarizado: la inserción de dependencias (DI) mencionada anteriormente y el trabajo con almacenes de datos asincrónicos en formularios Web Forms.</span><span class="sxs-lookup"><span data-stu-id="5d532-157">However, the catalog microservice introduces two techniques that might be unfamiliar: Dependency Injection (DI), which was mentioned earlier, and working with asynchronous data stores in Web Forms.</span></span>

<span data-ttu-id="5d532-158">DI invierte la estrategia típica orientada a objetos consistente en escribir clases que asignan todos los recursos necesarios.</span><span class="sxs-lookup"><span data-stu-id="5d532-158">DI inverts the typical object-oriented strategy of writing classes that allocate all needed resources.</span></span> <span data-ttu-id="5d532-159">En su lugar, las clases solicitan sus dependencias a un contenedor de servicios.</span><span class="sxs-lookup"><span data-stu-id="5d532-159">Instead, classes request their dependencies from a service container.</span></span> <span data-ttu-id="5d532-160">La ventaja de DI es que puede reemplazar a los servicios externos por emulaciones (objetos ficticios) para admitir entornos de pruebas o de otro tipo.</span><span class="sxs-lookup"><span data-stu-id="5d532-160">The advantage of DI is that you can replace external services with fakes (mocks) to support testing or other environments.</span></span>

<span data-ttu-id="5d532-161">El contenedor de DI usa la configuración appSettings de web.config para controlar si se van a usar los datos falsos del catálogo o los datos activos del servicio en ejecución.</span><span class="sxs-lookup"><span data-stu-id="5d532-161">The DI container uses the web.config appSettings configuration to control whether to use the fake catalog data or the live data from the running service.</span></span> <span data-ttu-id="5d532-162">La aplicación registra un objeto HttpModule que crea el contenedor y registra un controlador de solicitud previa para insertar las dependencias.</span><span class="sxs-lookup"><span data-stu-id="5d532-162">The application registers an HttpModule object that builds the container and registers a pre-request handler to inject dependencies.</span></span> <span data-ttu-id="5d532-163">Puede ver ese código en el archivo Modules/AutoFacHttpModule.cs, que es similar al ejemplo siguiente:</span><span class="sxs-lookup"><span data-stu-id="5d532-163">You can see that code in the Modules/AutoFacHttpModule.cs file, which looks like the following example:</span></span>

```cs
private static IContainer CreateContainer()
{
  // Configure AutoFac:
  // Register Containers:

  var settings = WebConfigurationManager.AppSettings;
  var useFake = settings["usefake"];
  bool fake = useFake == "true";
  var builder = new ContainerBuilder();

  if (fake)
  {
    builder.RegisterType<CatalogMockService>()
    .As<ICatalogService>();
  }
  else
  {
    builder.RegisterType<CatalogService>()
    .As<ICatalogService>();
    builder.RegisterType<RequestProvider>()
    .As<IRequestProvider>();
  }

  var container = builder.Build();
  return container;
}

private void InjectDependencies()
{
  if (HttpContext.Current.CurrentHandler is Page page)
  {
    // Get the code-behind class that we may have written
    var pageType = page.GetType().BaseType;

    // Determine if there is a constructor to inject, and grab it
    var ctor = (from c in pageType.GetConstructors()
                where c.GetParameters().Length > 0
                select c).FirstOrDefault();

    if (ctor != null)
    {
      // Resolve the parameters for the constructor
      var args = (from parm in ctor.GetParameters()
                  select Container.Resolve(parm.ParameterType))
                  .ToArray();

      // Execute the constructor method with the arguments resolved
      ctor.Invoke(page, args);
    }

    // Use the Autofac method to inject any
    // properties that can be filled by Autofac
    Container.InjectProperties(page);
  }
}
```

<span data-ttu-id="5d532-164">Las páginas de la aplicación (Default.aspx.cs y EditPage.aspx.cs) definen constructores que toman estas dependencias.</span><span class="sxs-lookup"><span data-stu-id="5d532-164">The application’s pages (Default.aspx.cs and EditPage.aspx.cs) define constructors that take these dependencies.</span></span> <span data-ttu-id="5d532-165">Observe que el constructor predeterminado sigue estando presente y es accesible.</span><span class="sxs-lookup"><span data-stu-id="5d532-165">Note that the default constructor is still present and accessible.</span></span> <span data-ttu-id="5d532-166">La infraestructura necesita el código siguiente.</span><span class="sxs-lookup"><span data-stu-id="5d532-166">The infrastructure needs the following code.</span></span>

```cs
protected _Default() { }

public _Default(ICatalogService catalog) => this.catalog = catalog;
```

<span data-ttu-id="5d532-167">Todas las API de catálogo son métodos asincrónicos.</span><span class="sxs-lookup"><span data-stu-id="5d532-167">The catalog APIs are all asynchronous methods.</span></span> <span data-ttu-id="5d532-168">Los formularios Web Forms ahora las admiten para todos los controles de datos.</span><span class="sxs-lookup"><span data-stu-id="5d532-168">Web Forms now supports these for all data controls.</span></span> <span data-ttu-id="5d532-169">La aplicación Catalog.WebForms usa el enlace de modelos para las páginas de lista y edición; los controles de las páginas definen las propiedades SelectMethod, UpdateMethod, InsertMethod y DeleteMethod que especifican las operaciones asincrónicas de devolución de tarea.</span><span class="sxs-lookup"><span data-stu-id="5d532-169">The Catalog.WebForms application uses model binding for the list and edit pages; controls on the pages define SelectMethod, UpdateMethod, InsertMethod, and DeleteMethod properties that specify Task-returning asynchronous operations.</span></span> <span data-ttu-id="5d532-170">Los controles de los formularios Web Forms entienden cuándo son asincrónicos los métodos enlazados a un control.</span><span class="sxs-lookup"><span data-stu-id="5d532-170">Web Forms controls understand when the methods bound to a control are asynchronous.</span></span> <span data-ttu-id="5d532-171">La única restricción con la que se encontrará al usar determinados métodos asincrónicos es que no se admite la paginación.</span><span class="sxs-lookup"><span data-stu-id="5d532-171">The only restriction you encounter when using asynchronous select methods is that you cannot support paging.</span></span> <span data-ttu-id="5d532-172">La firma de paginación requiere un parámetro out y los métodos asincrónicos no pueden tener parámetros out.</span><span class="sxs-lookup"><span data-stu-id="5d532-172">The paging signature requires an out parameter, and asynchronous methods cannot have out parameters.</span></span> <span data-ttu-id="5d532-173">Esta misma técnica se usa en otras páginas que requieren datos del servicio de catálogo.</span><span class="sxs-lookup"><span data-stu-id="5d532-173">This same technique is used on other pages that require data from the catalog service.</span></span>

<span data-ttu-id="5d532-174">La configuración predeterminada de la aplicación de catálogo de formularios Web Forms usa una implementación ficticia del servicio catalog.api.</span><span class="sxs-lookup"><span data-stu-id="5d532-174">The default configuration for the catalog Web Forms application uses a mock implementation of the catalog.api service.</span></span> <span data-ttu-id="5d532-175">Dicha implementación ficticia usa un conjunto de datos codificados de forma rígida para sus datos, lo que simplifica algunas tareas al quitar la dependencia del servicio catalog.api en entornos de desarrollo.</span><span class="sxs-lookup"><span data-stu-id="5d532-175">This mock uses a hard-coded dataset for its data, which simplifies some tasks by removing the dependency on the catalog.api service in development environments.</span></span>

## <a name="lifting-and-shifting"></a><span data-ttu-id="5d532-176">Migración mediante lift-and-shift</span><span class="sxs-lookup"><span data-stu-id="5d532-176">Lifting and shifting</span></span>

<span data-ttu-id="5d532-177">Visual Studio proporciona una excelente compatibilidad para incluir una aplicación en un contenedor.</span><span class="sxs-lookup"><span data-stu-id="5d532-177">Visual Studio provides great support for containerizing an application.</span></span> <span data-ttu-id="5d532-178">Haga clic con el botón derecho en el nodo del proyecto y seleccione **Agregar** y **Compatibilidad con Docker**.</span><span class="sxs-lookup"><span data-stu-id="5d532-178">You right-click the project node and then select **Add** and **Docker Support**.</span></span> <span data-ttu-id="5d532-179">La plantilla de proyecto de Docker agrega un nuevo proyecto a la solución denominado **docker-compose**.</span><span class="sxs-lookup"><span data-stu-id="5d532-179">The Docker project template adds a new project to the solution called **docker-compose**.</span></span> <span data-ttu-id="5d532-180">El proyecto contiene los activos de Docker que componen (o compilan) las imágenes que necesita y empieza a ejecutar los contenedores necesarios, tal como se muestra en la figura 7-3.</span><span class="sxs-lookup"><span data-stu-id="5d532-180">The project contains the Docker assets that compose (or build) the images you need, and starts running the necessary containers, as shown in Figure 7-3.</span></span>

<span data-ttu-id="5d532-181">En los escenarios más simples de migración mediante lift-and-shift, la aplicación será el único servicio que usará para la aplicación de formularios Web Forms.</span><span class="sxs-lookup"><span data-stu-id="5d532-181">In the simplest lift-and-shift scenarios, the application will be the single service that you use for the Web Forms application.</span></span> <span data-ttu-id="5d532-182">La plantilla también cambia el proyecto de inicio para que apunte al proyecto **docker-compose**.</span><span class="sxs-lookup"><span data-stu-id="5d532-182">The template also changes your startup project to point to the **docker-compose** project.</span></span> <span data-ttu-id="5d532-183">Ahora, al presionar CTRL+F5 o F5, creará la imagen de Docker e iniciará el contenedor de Docker.</span><span class="sxs-lookup"><span data-stu-id="5d532-183">Pressing Ctrl+F5 or F5 now creates the Docker image and launches the Docker container.</span></span>

![](./media/image3.png)

<span data-ttu-id="5d532-184">**Figura 7-3**.</span><span class="sxs-lookup"><span data-stu-id="5d532-184">**Figure 7-3**.</span></span> <span data-ttu-id="5d532-185">El proyecto **docker-compose** en la solución de formularios Web Forms.</span><span class="sxs-lookup"><span data-stu-id="5d532-185">The **docker-compose** project in the Web Forms solution</span></span>

<span data-ttu-id="5d532-186">Antes de ejecutar la solución, debe asegurarse de que ha configurado Docker para usar contenedores de Windows.</span><span class="sxs-lookup"><span data-stu-id="5d532-186">Before you run the solution, you must make sure that you configure Docker to use Windows Containers.</span></span> <span data-ttu-id="5d532-187">Para ello, haga clic con el botón derecho en el icono de la barra de tareas de Docker en Windows y seleccione **Switch to Windows Containers** (Cambiar a contenedores de Windows), como se muestra en la figura 7-4.</span><span class="sxs-lookup"><span data-stu-id="5d532-187">To do that, you right-click the Docker taskbar icon in Windows and select **Switch to Windows Containers**, as shown in Figure 7-4.</span></span>

![](./media/image4.png)

<span data-ttu-id="5d532-188">**Figura 7-4**.</span><span class="sxs-lookup"><span data-stu-id="5d532-188">**Figure 7-4**.</span></span> <span data-ttu-id="5d532-189">Cambiar a contenedores de Windows desde el icono de la barra de tareas de Docker en Windows.</span><span class="sxs-lookup"><span data-stu-id="5d532-189">Switching to Windows Containers from the Docker taskbar icon in Windows</span></span>

<span data-ttu-id="5d532-190">Si el elemento de menú indica **Switch to Linux containers** (Cambiar a contenedores de Linux), ya está ejecutando Docker con contenedores de Windows.</span><span class="sxs-lookup"><span data-stu-id="5d532-190">If the menu item says **Switch to Linux containers**, you are already running Docker with Windows Containers.</span></span>

<span data-ttu-id="5d532-191">Al ejecutar la solución, se reinicia el host de Docker.</span><span class="sxs-lookup"><span data-stu-id="5d532-191">Running the solution restarts the Docker host.</span></span> <span data-ttu-id="5d532-192">Al compilar, la aplicación y la imagen de Docker se compilan para el proyecto de formularios Web Forms.</span><span class="sxs-lookup"><span data-stu-id="5d532-192">When you build, you build the application and the Docker image for the Web Forms project.</span></span> <span data-ttu-id="5d532-193">La primera vez que lo haga, tardará bastante.</span><span class="sxs-lookup"><span data-stu-id="5d532-193">The first time you do this, it takes considerable time.</span></span> <span data-ttu-id="5d532-194">Esto se debe a que el proceso de compilación extrae la imagen base de Windows Server y la imagen adicional para ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="5d532-194">This is because the build process pulls down the base Windows Server image and the additional image for ASP.NET.</span></span> <span data-ttu-id="5d532-195">Los ciclos posteriores de compilación y ejecución serán mucho más rápidos.</span><span class="sxs-lookup"><span data-stu-id="5d532-195">Subsequent build and run cycles will be much faster.</span></span>

<span data-ttu-id="5d532-196">Examinemos con detalle los archivos que ha agregado la plantilla de proyecto de Docker.</span><span class="sxs-lookup"><span data-stu-id="5d532-196">Let’s take a deeper look at the files added by the Docker project template.</span></span> <span data-ttu-id="5d532-197">Ha creado varios archivos</span><span class="sxs-lookup"><span data-stu-id="5d532-197">It created several files for you.</span></span> <span data-ttu-id="5d532-198">que Visual Studio usa para crear la imagen de Docker e iniciar un contenedor.</span><span class="sxs-lookup"><span data-stu-id="5d532-198">Visual Studio uses these files to create the Docker image and launch a container.</span></span> <span data-ttu-id="5d532-199">Puede usar los mismos archivos desde la CLI para ejecutar comandos de Docker manualmente.</span><span class="sxs-lookup"><span data-stu-id="5d532-199">You can use the same files from the CLI to run Docker commands manually.</span></span>

<span data-ttu-id="5d532-200">En el siguiente ejemplo de Dockerfile se muestra la configuración básica para compilar una imagen de Docker basada en la imagen de ASP.NET de Windows que ejecuta un sitio de ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="5d532-200">The following Dockerfile example shows the basic settings for building a Docker image based on the Windows ASP.NET image that runs an ASP.NET site.</span></span>

```
FROM microsoft/aspnet

ARG source

WORKDIR /inetpub/wwwroot

COPY ${source:-obj/Docker/publish} .
```

<span data-ttu-id="5d532-201">Este archivo Dockerfile tendrá un aspecto muy similar a los creados para ejecutar una aplicación de ASP.NET Core en contenedores de Linux.</span><span class="sxs-lookup"><span data-stu-id="5d532-201">This Dockerfile will look very similar to those created for running an ASP.NET Core application in Linux containers.</span></span> <span data-ttu-id="5d532-202">Aun así, hay algunas diferencias importantes.</span><span class="sxs-lookup"><span data-stu-id="5d532-202">However, there are a few important differences.</span></span> <span data-ttu-id="5d532-203">La más importante es que la imagen base es microsoft/aspnet, que es la imagen actual de Windows Server que incluye .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="5d532-203">The most important difference is that the base image is microsoft/aspnet, which is the current Windows Server image that includes the .NET Framework.</span></span> <span data-ttu-id="5d532-204">Otra diferencia es que los directorios copiados del directorio de origen son diferentes.</span><span class="sxs-lookup"><span data-stu-id="5d532-204">Other differences are that the directories copied from your source directory are different.</span></span>

<span data-ttu-id="5d532-205">Los demás archivos del proyecto **docker-compose** son los activos de Docker necesarios para compilar y configurar los contenedores.</span><span class="sxs-lookup"><span data-stu-id="5d532-205">The other files in the **docker-compose** project are the Docker assets needed to build and configure the containers.</span></span> <span data-ttu-id="5d532-206">Visual Studio coloca los diversos archivos docker-compose.yml en un nodo para resaltar cómo se usan.</span><span class="sxs-lookup"><span data-stu-id="5d532-206">Visual Studio puts the various docker-compose.yml files under one node to highlight how they are used.</span></span> <span data-ttu-id="5d532-207">El archivo base docker-compose contiene las directivas que son comunes a todas las configuraciones.</span><span class="sxs-lookup"><span data-stu-id="5d532-207">The base docker-compose file contains the directives that are common to all configurations.</span></span> <span data-ttu-id="5d532-208">El archivo docker-compose.override.yml contiene variables de entorno y los reemplazos relacionados para una configuración de desarrollador.</span><span class="sxs-lookup"><span data-stu-id="5d532-208">The docker-compose.override.yml file contains environment variables and related overrides for a developer configuration.</span></span> <span data-ttu-id="5d532-209">Las variantes con .vs.debug y .vs.release proporcionan una configuración de entorno que permite a Visual Studio adjuntar elementos al contenedor en ejecución y administrarlo.</span><span class="sxs-lookup"><span data-stu-id="5d532-209">The variants with .vs.debug and .vs.release provide environment settings that enable Visual Studio to attach to and manage the running container.</span></span>

<span data-ttu-id="5d532-210">Aunque la integración de Visual Studio forma parte de la compatibilidad con la adición de Docker a la solución, también puede compilar y ejecutar desde la línea de comandos mediante el comando docker-compose up, como ha visto en secciones anteriores.</span><span class="sxs-lookup"><span data-stu-id="5d532-210">While Visual Studio integration is part of adding Docker support to your solution, you can also build and run from the command line, using the docker-compose up command, as you saw in previous sections.</span></span>

## <a name="getting-data-from-the-existing-catalog-net-core-microservice"></a><span data-ttu-id="5d532-211">Obtener datos del microservicio de catálogo existente de .NET Core</span><span class="sxs-lookup"><span data-stu-id="5d532-211">Getting data from the existing catalog .NET Core microservice</span></span>

<span data-ttu-id="5d532-212">Puede configurar la aplicación de formularios Web Forms para usar el microservicio de catálogo eShopOnContainers para obtener datos en lugar de usar datos falsos.</span><span class="sxs-lookup"><span data-stu-id="5d532-212">You can configure the Web Forms application to use the eShopOnContainers catalog microservice to get data instead of using fake data.</span></span> <span data-ttu-id="5d532-213">Para ello, edite el archivo web.config y establezca el valor de la clave useFake en false.</span><span class="sxs-lookup"><span data-stu-id="5d532-213">To do this, you edit the web.config file and set the value of the useFake key to false.</span></span> <span data-ttu-id="5d532-214">El contenedor de inserción de dependencias usará la clase que tiene acceso al microservicio de catálogo activo en lugar de la clase que devuelve los datos codificados de forma rígida.</span><span class="sxs-lookup"><span data-stu-id="5d532-214">The DI container will use the class that accesses the live catalog microservice instead of the class that returns the hard-coded data.</span></span> <span data-ttu-id="5d532-215">No se necesita ningún otro cambio de código.</span><span class="sxs-lookup"><span data-stu-id="5d532-215">No other code changes are needed.</span></span>

<span data-ttu-id="5d532-216">Para obtener acceso al servicio de catálogo activo tiene que actualizar el proyecto **docker-compose** para compilar la imagen del servicio de catálogo e iniciar el contenedor de servicio de catálogo.</span><span class="sxs-lookup"><span data-stu-id="5d532-216">Accessing the live catalog service does mean you need to update the **docker-compose** project to build the catalog service image and launch the catalog service container.</span></span> <span data-ttu-id="5d532-217">Docker CE para Windows es compatible con contenedores de Linux y con contenedores de Windows, pero no al mismo tiempo.</span><span class="sxs-lookup"><span data-stu-id="5d532-217">Docker CE for Windows supports both Linux containers and Windows Containers, but not at the same time.</span></span> <span data-ttu-id="5d532-218">Para ejecutar el microservicio de catálogo, debe compilar una imagen que ejecute el microservicio de catálogo sobre un contenedor de Windows.</span><span class="sxs-lookup"><span data-stu-id="5d532-218">To run the catalog microservice, you need to build an image that runs the catalog microservice on top of a Windows-based container.</span></span> <span data-ttu-id="5d532-219">Este enfoque requiere para el proyecto de microservicios un archivo Dockerfile diferente del que ha visto en secciones anteriores.</span><span class="sxs-lookup"><span data-stu-id="5d532-219">This approach requires a different Dockerfile for the microservices project than you have seen in earlier sections.</span></span> <span data-ttu-id="5d532-220">El archivo Dockerfile.windows contiene los valores de configuración necesarios para compilar la imagen de contenedor de la API de catálogo de modo que se ejecute en un contenedor de Windows, por ejemplo, para usar una imagen de Docker de Windows Nano.</span><span class="sxs-lookup"><span data-stu-id="5d532-220">The Dockerfile.windows file contains the configuration settings to build the catalog API container image so that it runs on a Windows container—for example, to use a Windows Nano Docker image.</span></span>

<span data-ttu-id="5d532-221">El catálogo de microservicio se fundamenta en la base de datos de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="5d532-221">The catalog microservice relies on the SQL Server database.</span></span> <span data-ttu-id="5d532-222">Por lo tanto, debe usar también una imagen de Docker de SQL Server basada en Windows.</span><span class="sxs-lookup"><span data-stu-id="5d532-222">Therefore, you need to use a Windows-based SQL Server Docker image as well.</span></span>

<span data-ttu-id="5d532-223">Después de estos cambios, el proyecto docker-compose lleva a cabo más acciones para iniciar la aplicación.</span><span class="sxs-lookup"><span data-stu-id="5d532-223">After these changes, the docker-compose project does more to start the application.</span></span> <span data-ttu-id="5d532-224">El proyecto inicia ahora SQL Server con la imagen de SQL Server basada en Windows,</span><span class="sxs-lookup"><span data-stu-id="5d532-224">The project now starts the SQL Server using the Windows based SQL Server image.</span></span> <span data-ttu-id="5d532-225">inicia el microservicio de catálogo en un contenedor de Windows</span><span class="sxs-lookup"><span data-stu-id="5d532-225">It starts the catalog microservice in a Windows container.</span></span> <span data-ttu-id="5d532-226">e inicia el contenedor del editor de catálogo de formularios Web Forms, también en un contenedor de Windows.</span><span class="sxs-lookup"><span data-stu-id="5d532-226">And it starts the Web Forms catalog editor container, also in a Windows container.</span></span> <span data-ttu-id="5d532-227">Si es necesario compilar alguna de las imágenes, se crean en primer lugar.</span><span class="sxs-lookup"><span data-stu-id="5d532-227">If any of the images need building, the images are created first.</span></span>

## <a name="development-and-production-environments"></a><span data-ttu-id="5d532-228">Entornos de desarrollo y producción</span><span class="sxs-lookup"><span data-stu-id="5d532-228">Development and production environments</span></span>

<span data-ttu-id="5d532-229">Hay un par de diferencias entre la configuración de desarrollo y la configuración de producción.</span><span class="sxs-lookup"><span data-stu-id="5d532-229">There are a couple of differences between the development configuration and a production configuration.</span></span> <span data-ttu-id="5d532-230">En el entorno de desarrollo, puede ejecutar la aplicación de formularios Web Forms, el microservicio de catálogo y SQL Server en contenedores de Windows, como parte del mismo host de Docker.</span><span class="sxs-lookup"><span data-stu-id="5d532-230">In the development environment, you run the Web Forms application, the catalog microservice, and SQL Server in Windows Containers, as part of the same Docker host.</span></span> <span data-ttu-id="5d532-231">En las secciones anteriores, hemos mencionado imágenes de SQL Server implementadas en el mismo host de Docker que los demás servicios basados en .NET Core en un host de Docker basado en Linux.</span><span class="sxs-lookup"><span data-stu-id="5d532-231">In earlier sections, we mentioned SQL Server images deployed in the same Docker host as the other .NET Core-based services on a Linux-based Docker host.</span></span> <span data-ttu-id="5d532-232">La ventaja de ejecutar los diversos microservicios en el mismo host de Docker (o clúster) es que hay menos comunicación de red y la comunicación entre los contenedores tiene una latencia inferior.</span><span class="sxs-lookup"><span data-stu-id="5d532-232">The advantage of running the multiple microservices in the same Docker host (or cluster) is that there is less network communication and the communication between containers has lower latency.</span></span>

<span data-ttu-id="5d532-233">En el entorno de desarrollo, debe ejecutar todos los contenedores en el mismo sistema operativo.</span><span class="sxs-lookup"><span data-stu-id="5d532-233">In the development environment, you must run all the containers in the same OS.</span></span> <span data-ttu-id="5d532-234">Docker CE para Windows no admite la ejecución simultánea de contenedores basados en Windows y en Linux.</span><span class="sxs-lookup"><span data-stu-id="5d532-234">Docker CE for Windows does not support running Windows- and Linux-based containers at the same time.</span></span> <span data-ttu-id="5d532-235">En producción, puede decidir si quiere ejecutar el microservicio de catálogo en un contenedor de Windows en un solo host de Docker (o clúster), o bien si prefiere que la aplicación de formularios Web Forms se comunique con una instancia del microservicio de catálogo que se ejecuta en un contenedor de Linux en un host de Docker diferente.</span><span class="sxs-lookup"><span data-stu-id="5d532-235">In production, you can decide if you want to run the catalog microservice in a Windows container in a single Docker host (or cluster), or have the Web Forms application communicate with an instance of the catalog microservice running in a Linux container on a different Docker host.</span></span> <span data-ttu-id="5d532-236">Depende de cómo quiera optimizar la latencia de red.</span><span class="sxs-lookup"><span data-stu-id="5d532-236">It depends on how you want to optimize for network latency.</span></span> <span data-ttu-id="5d532-237">En la mayoría de los casos, le interesará que los microservicios de los que dependen sus aplicaciones se ejecuten en el mismo host de Docker (o conjunto) para facilitar la implementación y para que la latencia de comunicación sea inferior.</span><span class="sxs-lookup"><span data-stu-id="5d532-237">In most cases, you want the microservices that your applications depend on running in the same Docker host (or swarm) for ease of deployment and lower communication latency.</span></span> <span data-ttu-id="5d532-238">En estas configuraciones, la única comunicación costosa es la que se establece entre las instancias de microservicios y los servidores de alta disponibilidad para el almacenamiento de datos persistentes.</span><span class="sxs-lookup"><span data-stu-id="5d532-238">In those configurations, the only costly communications is between the microservice instances and the high-availability servers for the persistent data storage.</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="5d532-239">[Anterior] (../net-core-single-containers-linux-windows-server-hosts/index.md) [Siguiente] (../multi-container-microservice-net-applications/index.md)</span><span class="sxs-lookup"><span data-stu-id="5d532-239">[Previous] (../net-core-single-containers-linux-windows-server-hosts/index.md) [Next] (../multi-container-microservice-net-applications/index.md)</span></span>
