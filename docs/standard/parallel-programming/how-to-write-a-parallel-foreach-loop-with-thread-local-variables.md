---
title: 'Cómo: Escribir un bucle Parallel.ForEach con variables locales de subproceso'
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel foreach loop, how to use local state
ms.assetid: 24b10041-b30b-45cb-aa65-66cf568ca76d
author: rpetrusha
ms.author: ronpet
ms.openlocfilehash: 4a89b3f25fb3d6e85c666e57f24e68c297c8c29a
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 05/04/2018
ms.locfileid: "33582742"
---
# <a name="how-to-write-a-parallelforeach-loop-with-thread-local-variables"></a><span data-ttu-id="744c2-102">Cómo: Escribir un bucle Parallel.ForEach con variables locales de subproceso</span><span class="sxs-lookup"><span data-stu-id="744c2-102">How to: Write a Parallel.ForEach Loop with Thread-Local Variables</span></span>
<span data-ttu-id="744c2-103">En el siguiente ejemplo se muestra cómo escribir un método <xref:System.Threading.Tasks.Parallel.ForEach%2A> que utiliza variables locales de subproceso.</span><span class="sxs-lookup"><span data-stu-id="744c2-103">The following example shows how to write a <xref:System.Threading.Tasks.Parallel.ForEach%2A> method that uses thread-local variables.</span></span> <span data-ttu-id="744c2-104">Cuando un bucle <xref:System.Threading.Tasks.Parallel.ForEach%2A> se ejecuta, divide su colección de origen en varias particiones.</span><span class="sxs-lookup"><span data-stu-id="744c2-104">When a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop executes, it divides its source collection into multiple partitions.</span></span> <span data-ttu-id="744c2-105">Cada partición obtendrá su propia copia de la variable "local de subproceso".</span><span class="sxs-lookup"><span data-stu-id="744c2-105">Each partition will get its own copy of the "thread-local" variable.</span></span> <span data-ttu-id="744c2-106">(El término "local de subproceso" es ligeramente inexacto, porque en algunos casos dos particiones se pueden ejecutar en el mismo subproceso).</span><span class="sxs-lookup"><span data-stu-id="744c2-106">(The term "thread-local" is slightly inaccurate here, because in some cases two partitions may run on the same thread.)</span></span>  
  
 <span data-ttu-id="744c2-107">El código y los parámetros de este ejemplo se parecen mucho al método <xref:System.Threading.Tasks.Parallel.For%2A> correspondiente.</span><span class="sxs-lookup"><span data-stu-id="744c2-107">The code and parameters in this example closely resemble the corresponding <xref:System.Threading.Tasks.Parallel.For%2A> method.</span></span> <span data-ttu-id="744c2-108">Para más información, vea [Cómo: Escribir un bucle Parallel.For con variables locales de subproceso](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md).</span><span class="sxs-lookup"><span data-stu-id="744c2-108">For more information, see [How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md).</span></span>  
  
 <span data-ttu-id="744c2-109">Para utilizar una variable local de subproceso en un bucle <xref:System.Threading.Tasks.Parallel.ForEach%2A>, realice una llamada a una de las sobrecargas del método que toma dos parámetros de tipo.</span><span class="sxs-lookup"><span data-stu-id="744c2-109">To use a thread-local variable in a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop, you must call one of the method overloads that takes two type parameters.</span></span> <span data-ttu-id="744c2-110">El primer parámetro de tipo, `TSource`, especifica el tipo del elemento de origen, mientras que el segundo parámetro de tipo, `TLocal`, especifica el tipo de la variable local de subproceso.</span><span class="sxs-lookup"><span data-stu-id="744c2-110">The first type parameter, `TSource`, specifies the type of the source element, and the second type parameter, `TLocal`, specifies the type of the thread-local variable.</span></span>  
  
## <a name="example"></a><span data-ttu-id="744c2-111">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="744c2-111">Example</span></span>  
 <span data-ttu-id="744c2-112">En el ejemplo siguiente se realiza una llamada a la sobrecarga <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> para calcular la suma de una matriz de un millón de elementos.</span><span class="sxs-lookup"><span data-stu-id="744c2-112">The following example calls <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> overload to compute the sum of an array of one million elements.</span></span> <span data-ttu-id="744c2-113">Esta sobrecarga gráfico tiene cuatro parámetros:</span><span class="sxs-lookup"><span data-stu-id="744c2-113">This overload has four parameters:</span></span>  
  
-   <span data-ttu-id="744c2-114">`source`, que es el origen de datos.</span><span class="sxs-lookup"><span data-stu-id="744c2-114">`source`, which is the data source.</span></span> <span data-ttu-id="744c2-115">Debe implementar <xref:System.Collections.Generic.IEnumerable%601>.</span><span class="sxs-lookup"><span data-stu-id="744c2-115">It must implement <xref:System.Collections.Generic.IEnumerable%601>.</span></span> <span data-ttu-id="744c2-116">El origen de datos de este ejemplo es un objeto `IEnumerable<Int32>` de un millón de miembros que ha sido devuelto por el método <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="744c2-116">The data source in our example is the one million member `IEnumerable<Int32>` object returned by the <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType> method.</span></span>  
  
-   <span data-ttu-id="744c2-117">`localInit`, o la función que inicializa la variable local de subproceso.</span><span class="sxs-lookup"><span data-stu-id="744c2-117">`localInit`, or the function that initializes the thread-local variable.</span></span> <span data-ttu-id="744c2-118">Esta función se llama una vez por cada partición en la que se ejecuta la operación <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="744c2-118">This function is called once for each partition in which the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> operation executes.</span></span> <span data-ttu-id="744c2-119">En el ejemplo se inicializa la variable local de subproceso en cero.</span><span class="sxs-lookup"><span data-stu-id="744c2-119">Our example initializes the thread-local variable to zero.</span></span>  
  
-   <span data-ttu-id="744c2-120">`body`, un <xref:System.Func%604> al que invoca el bucle paralelo en cada iteración del mismo bucle.</span><span class="sxs-lookup"><span data-stu-id="744c2-120">`body`, a <xref:System.Func%604> that is invoked by the parallel loop on each iteration of the loop.</span></span> <span data-ttu-id="744c2-121">Su firma es `Func\<TSource, ParallelLoopState, TLocal, TLocal>`.</span><span class="sxs-lookup"><span data-stu-id="744c2-121">Its signature is `Func\<TSource, ParallelLoopState, TLocal, TLocal>`.</span></span> <span data-ttu-id="744c2-122">Se proporciona el código para el delegado y el bucle pasa los parámetros de entrada, que son:</span><span class="sxs-lookup"><span data-stu-id="744c2-122">You supply the code for the delegate, and the loop passes in the input parameters, which are:</span></span>  
  
    -   <span data-ttu-id="744c2-123">El elemento actual de <xref:System.Collections.Generic.IEnumerable%601>.</span><span class="sxs-lookup"><span data-stu-id="744c2-123">The current element of the <xref:System.Collections.Generic.IEnumerable%601>.</span></span>  
  
    -   <span data-ttu-id="744c2-124">Una variable <xref:System.Threading.Tasks.ParallelLoopState> que se puede usar en el código del delegado a fin de examinar el estado del bucle.</span><span class="sxs-lookup"><span data-stu-id="744c2-124">A <xref:System.Threading.Tasks.ParallelLoopState> variable that you can use in your delegate's code to examine the state of the loop.</span></span>  
  
    -   <span data-ttu-id="744c2-125">La variable local de subproceso.</span><span class="sxs-lookup"><span data-stu-id="744c2-125">The thread-local variable.</span></span>  
  
     <span data-ttu-id="744c2-126">El delegado devuelve la variable local de subproceso, y esta se pasa luego a la siguiente iteración del bucle que se ejecuta en esa partición concreta.</span><span class="sxs-lookup"><span data-stu-id="744c2-126">Your delegate returns the thread-local variable, which is then passed to the next iteration of the loop that executes in that particular partition.</span></span> <span data-ttu-id="744c2-127">Cada una de las particiones del bucle mantiene una instancia independiente de esta variable.</span><span class="sxs-lookup"><span data-stu-id="744c2-127">Each loop partition maintains a separate instance of this variable.</span></span>  
  
     <span data-ttu-id="744c2-128">En el ejemplo, el delegado agrega el valor de cada entero a la variable local de subproceso, que mantiene un total acumulativo de los valores de los elementos enteros de esa partición.</span><span class="sxs-lookup"><span data-stu-id="744c2-128">In the example, the delegate adds the value of each integer to the thread-local variable, which maintains a running total of the values of the integer elements in that partition.</span></span>  
  
-   <span data-ttu-id="744c2-129">`localFinally`, un delegado `Action<TLocal>` al que invoca <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> cuando se han completado las operaciones de bucle en las particiones.</span><span class="sxs-lookup"><span data-stu-id="744c2-129">`localFinally`, an `Action<TLocal>` delegate that the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> invokes when the looping operations in each partition have completed.</span></span> <span data-ttu-id="744c2-130">El método <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> pasa al delegado `Action<TLocal>` el valor final de la variable local de subproceso correspondiente a este subproceso (o partición del bucle), y usted proporciona el código que realiza la acción necesaria para combinar el resultado de esta partición con los resultados de las otras particiones.</span><span class="sxs-lookup"><span data-stu-id="744c2-130">The <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> method passes your `Action<TLocal>` delegate the final value of the thread-local variable for this thread (or loop partition), and you provide the code that performs the required action for combining the result from this partition with the results from the other partitions.</span></span> <span data-ttu-id="744c2-131">Varias tareas pueden invocar simultáneamente a este delegado.</span><span class="sxs-lookup"><span data-stu-id="744c2-131">This delegate can be invoked concurrently by multiple tasks.</span></span> <span data-ttu-id="744c2-132">Debido a esto, en el ejemplo se usa el método <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> se utiliza para sincronizar el acceso a la variable `total`.</span><span class="sxs-lookup"><span data-stu-id="744c2-132">Because of this, the example uses the <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> method to synchronize access to the `total` variable.</span></span> <span data-ttu-id="744c2-133">Como el tipo de delegado es <xref:System.Action%601>, no hay valor devuelto.</span><span class="sxs-lookup"><span data-stu-id="744c2-133">Because the delegate type is an <xref:System.Action%601>, there is no return value.</span></span>  
  
 [!code-csharp[TPL_Parallel#04](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/foreachthreadlocal.cs#04)]
 [!code-vb[TPL_Parallel#04](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/foreachthreadlocal.vb#04)]  
  
## <a name="see-also"></a><span data-ttu-id="744c2-134">Vea también</span><span class="sxs-lookup"><span data-stu-id="744c2-134">See Also</span></span>  
 <span data-ttu-id="744c2-135">[Data Parallelism](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md) (Paralelismo de datos)</span><span class="sxs-lookup"><span data-stu-id="744c2-135">[Data Parallelism](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)</span></span>  
 <span data-ttu-id="744c2-136">[How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md) (Cómo: Escribir un bucle Parallel.For con variables locales de subproceso)</span><span class="sxs-lookup"><span data-stu-id="744c2-136">[How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)</span></span>  
 [<span data-ttu-id="744c2-137">Expresiones lambda en PLINQ y TPL</span><span class="sxs-lookup"><span data-stu-id="744c2-137">Lambda Expressions in PLINQ and TPL</span></span>](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)
